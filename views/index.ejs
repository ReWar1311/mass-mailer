<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Pulse Courier ¬∑ Plan and launch thoughtful campaigns</title>
	<link rel="preconnect" href="https://fonts.googleapis.com" />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
	<script src="https://cdn.tailwindcss.com"></script>
	<script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
	<style>
		:root {
			color-scheme: dark;
		}

		*,
		*::before,
		*::after {
			box-sizing: border-box;
		}

		body {
			min-height: 100vh;
			font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
			background-color: #010514;
			color: #e2e8f0;
			line-height: 1.6;
		}

		a {
			color: inherit;
		}

		.skip-link {
			position: absolute;
			top: 0.75rem;
			left: 1rem;
			z-index: 50;
			padding: 0.5rem 1rem;
			background: #0f172a;
			color: #f8fafc;
			border-radius: 999px;
			transform: translateY(-150%);
			transition: transform 150ms ease;
		}

		.skip-link:focus-visible {
			transform: translateY(0);
			outline: 2px solid #38bdf8;
		}

		.glass-panel {
			background: rgba(2, 6, 23, 0.82);
			border: 1px solid rgba(148, 163, 184, 0.18);
			backdrop-filter: blur(30px);
			box-shadow: 0 35px 60px -40px rgba(15, 23, 42, 0.9);
		}

		.card-shadow {
			box-shadow: 0 45px 80px -60px rgba(15, 23, 42, 0.7);
		}

		.hero-shell {
			background: radial-gradient(circle at 10% 20%, rgba(14, 165, 233, 0.4), transparent 55%),
				radial-gradient(circle at 80% 0%, rgba(236, 72, 153, 0.35), transparent 60%),
				linear-gradient(120deg, #030617, #050b24 45%, #0a0f2b 100%);
			position: relative;
			isolation: isolate;
			overflow: hidden;
		}

		.hero-shell::after {
			content: '';
			position: absolute;
			inset: 0;
			pointer-events: none;
			background: radial-gradient(circle at 60% 10%, rgba(255, 255, 255, 0.12), transparent 40%),
				linear-gradient(60deg, rgba(255, 255, 255, 0.1), transparent 55%);
			mix-blend-mode: screen;
			opacity: 0.35;
		}

		.provider-card {
			border-radius: 1.5rem;
			border: 1px solid rgba(148, 163, 184, 0.3);
			background: rgba(15, 23, 42, 0.55);
			color: #cbd5f5;
			padding: 1rem;
			transition: border-color 200ms ease, background 200ms ease, transform 200ms ease, box-shadow 200ms ease;
		}

		.provider-card:hover,
		.provider-card:focus-visible {
			transform: translateY(-2px);
			outline: none;
			border-color: rgba(248, 250, 252, 0.7);
		}

		.provider-card.is-active {
			border-color: rgba(125, 211, 252, 0.9);
			background: rgba(34, 211, 238, 0.12);
			color: #f8fafc;
			box-shadow: 0 20px 50px -35px rgba(14, 165, 233, 0.7);
		}

		.form-alert {
			display: inline-flex;
			align-items: center;
			gap: 0.35rem;
			padding: 0.35rem 0.9rem;
			border-radius: 999px;
			font-size: 0.75rem;
			font-weight: 600;
			border: 1px solid transparent;
		}

		.form-alert-success {
			background: rgba(34, 197, 94, 0.18);
			color: #bbf7d0;
			border-color: rgba(34, 197, 94, 0.4);
		}

		.form-alert-error {
			background: rgba(244, 63, 94, 0.18);
			color: #fecdd3;
			border-color: rgba(244, 63, 94, 0.45);
		}

		.form-alert-warning {
			background: rgba(251, 191, 36, 0.15);
			color: #fde68a;
			border-color: rgba(251, 191, 36, 0.4);
		}

		.form-alert-info {
			background: rgba(59, 130, 246, 0.22);
			color: #bfdbfe;
			border-color: rgba(59, 130, 246, 0.4);
		}

		.status-pill {
			padding: 0.4rem 1rem;
			font-size: 0.68rem;
			letter-spacing: 0.18em;
			text-transform: uppercase;
			font-weight: 700;
			border-radius: 999px;
			border: 1px solid rgba(148, 163, 184, 0.35);
		}

		.status-pill--idle {
			background: rgba(15, 23, 42, 0.6);
		}

		.status-pill--queued {
			background: rgba(251, 191, 36, 0.15);
			color: #fde68a;
			border-color: rgba(251, 191, 36, 0.4);
		}

		.status-pill--running {
			background: rgba(56, 189, 248, 0.15);
			color: #bae6fd;
			border-color: rgba(56, 189, 248, 0.45);
		}

		.status-pill--completed {
			background: rgba(16, 185, 129, 0.15);
			color: #bbf7d0;
			border-color: rgba(16, 185, 129, 0.45);
		}

		.status-pill--failed {
			background: rgba(244, 63, 94, 0.15);
			color: #fecdd3;
			border-color: rgba(244, 63, 94, 0.45);
		}

		.dropzone {
			border: 1px dashed rgba(148, 163, 184, 0.45);
			border-radius: 1.5rem;
			background: rgba(15, 23, 42, 0.45);
			transition: border-color 150ms ease, background 150ms ease;
			padding: 1.5rem;
			cursor: pointer;
		}

		.dropzone--active {
			border-color: rgba(34, 211, 238, 0.8);
			background: rgba(34, 211, 238, 0.12);
		}

		.dark-table thead {
			background: rgba(15, 23, 42, 0.95);
		}

		.dark-table tbody tr:nth-child(odd) {
			background: rgba(15, 23, 42, 0.7);
		}

		.dark-table tbody tr:nth-child(even) {
			background: rgba(15, 23, 42, 0.55);
		}

		.stepper__item {
			border-radius: 1.5rem;
			border: 1px solid rgba(148, 163, 184, 0.3);
			background: rgba(15, 23, 42, 0.55);
			padding: 1rem;
			gap: 0.85rem;
		}

		.stepper__badge {
			flex-shrink: 0;
			height: 2.5rem;
			width: 2.5rem;
			border-radius: 1rem;
			background: rgba(248, 250, 252, 0.12);
			display: inline-flex;
			align-items: center;
			justify-content: center;
			font-weight: 600;
		}

		.quick-card {
			display: flex;
			gap: 1rem;
			align-items: center;
			border-radius: 1.5rem;
			border: 1px solid rgba(148, 163, 184, 0.2);
			background: rgba(15, 23, 42, 0.7);
			padding: 1.25rem;
			box-shadow: 0 35px 60px -45px rgba(15, 23, 42, 0.9);
		}

		.quick-card__icon {
			width: 3.25rem;
			height: 3.25rem;
			border-radius: 1.25rem;
			background: rgba(148, 163, 184, 0.15);
			display: grid;
			place-items: center;
			font-size: 1.4rem;
		}

		.quick-card__value {
			font-size: 1.1rem;
			font-weight: 600;
		}

		.quick-card[data-state='ready'] {
			border-color: rgba(34, 197, 94, 0.5);
			background: rgba(16, 185, 129, 0.08);
		}

		.quick-card[data-state='ready'] .quick-card__value {
			color: #bbf7d0;
		}

		.preview-card {
			border-radius: 1.5rem;
			border: 1px solid rgba(148, 163, 184, 0.25);
			background: rgba(2, 6, 23, 0.65);
			padding: 1rem;
		}

		.preview-body {
			overflow: hidden;
			display: -webkit-box;
			line-clamp: 3;
			-webkit-line-clamp: 3;
			-webkit-box-orient: vertical;
		}

		.readiness-item {
			display: flex;
			align-items: center;
			gap: 0.9rem;
			padding: 0.85rem 1rem;
			border-radius: 1.25rem;
			border: 1px solid rgba(148, 163, 184, 0.18);
			background: rgba(15, 23, 42, 0.6);
		}

		.readiness-indicator {
			width: 0.85rem;
			height: 0.85rem;
			border-radius: 999px;
			background: rgba(248, 250, 252, 0.25);
		}

		.readiness-item[data-state='done'] {
			border-color: rgba(16, 185, 129, 0.5);
			background: rgba(16, 185, 129, 0.08);
		}

		.readiness-item[data-state='done'] .readiness-indicator {
			background: #34d399;
			box-shadow: 0 0 0 6px rgba(52, 211, 153, 0.2);
		}

		.readiness-chip {
			margin-left: auto;
			font-size: 0.7rem;
			letter-spacing: 0.18em;
			text-transform: uppercase;
			border-radius: 999px;
			padding: 0.2rem 0.8rem;
			border: 1px solid rgba(148, 163, 184, 0.3);
		}

		.readiness-item[data-state='done'] .readiness-chip {
			border-color: rgba(16, 185, 129, 0.6);
			color: #bbf7d0;
		}

		summary::-webkit-details-marker {
			display: none;
		}

		@media (prefers-reduced-motion: reduce) {
			*,
			*::before,
			*::after {
				animation-duration: 0.01ms !important;
				animation-iteration-count: 1 !important;
				transition-duration: 0.01ms !important;
				scroll-behavior: auto !important;
			}
		}
	</style>
</head>

<body class="bg-slate-950 text-slate-100 h-screen lg:overflow-hidden pt-4">
	<a href="#campaignForm" class="skip-link">Skip to campaign form</a>
	<main class=" mx-auto px-4 sm:px-6 lg:px-10 mt-12 pb-24 space-y-10">
		<section class="grid gap-8 lg:grid-cols-3" id="campaignForm">
			<div class="lg:h-screen lg:pb-20 lg:col-span-2 space-y-8 overflow-y-auto">
				<form id="mailerForm" class="glass-panel rounded-[32px] p-8 space-y-8" action="/api/send" method="post" enctype="multipart/form-data" data-max-recipients="<%= defaults.maxRecipients %>" data-max-file-mb="<%= defaults.maxFileMb %>">
					<div class="flex flex-wrap items-center gap-3 justify-between">
						<div>
							<p class="text-sm uppercase tracking-[0.3em] text-slate-400">Campaign details</p>
							<h2 class="text-2xl font-semibold mt-2">Launch settings</h2>
						</div>
						<div class="flex gap-2" id="formActions">
							<button type="button" id="sampleCopyButton" class="px-3 py-2 text-sm rounded-2xl border border-white/20 text-slate-200 hover:text-white">Load sample copy</button>
							<button type="button" id="resetFormButton" class="px-3 py-2 text-sm rounded-2xl border border-white/20 text-slate-200 hover:text-white">Reset form</button>
						</div>
					</div>

					<fieldset class="space-y-4">
						<legend class="text-sm font-semibold tracking-[0.2em] uppercase text-slate-400">Sender identity</legend>
						<div class="grid gap-4 md:grid-cols-2">
							<label class="text-sm space-y-2">Sender name
								<input type="text" name="senderName" class="w-full rounded-2xl bg-slate-900/60 border border-white/10 px-4 py-3 focus:outline-none focus:border-cyan-300" placeholder="Ops team" />
							</label>
							<label class="text-sm space-y-2">Sender email
								<input type="email" name="senderEmail" required class="w-full rounded-2xl bg-slate-900/60 border border-white/10 px-4 py-3 focus:outline-none focus:border-cyan-300" placeholder="ops@yourdomain.com" />
							</label>
						</div>
						<div class="grid gap-4 md:grid-cols-3">
							<label class="text-sm space-y-2">App password / API key
								<input type="password" name="appPassword" required class="w-full rounded-2xl bg-slate-900/60 border border-white/10 px-4 py-3 focus:outline-none focus:border-cyan-300" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
							</label>
							<label class="text-sm space-y-2">SMTP host
								<input type="text" name="smtpHost" value="<%= defaults.smtpHost %>" class="w-full rounded-2xl bg-slate-900/60 border border-white/10 px-4 py-3 focus:outline-none focus:border-cyan-300" />
							</label>
							<label class="text-sm space-y-2">SMTP port
								<input type="number" name="smtpPort" value="<%= defaults.smtpPort %>" class="w-full rounded-2xl bg-slate-900/60 border border-white/10 px-4 py-3 focus:outline-none focus:border-cyan-300" />
							</label>
						</div>
					</fieldset>

					<fieldset class="space-y-5">
						<legend class="text-sm font-semibold tracking-[0.2em] uppercase text-slate-400">Provider presets</legend>
						<!-- <div class="flex flex-wrap gap-3" role="radiogroup" aria-label="SMTP provider" id="providerCards">
							<button type="button" class="provider-card text-left flex-1 min-w-[220px]" data-provider="custom" aria-checked="false" role="radio">
								<p class="font-semibold">Custom SMTP</p>
								<p class="text-sm text-slate-300">Manually configure host + port</p>
							</button>
							<% (providers || []).forEach(function(provider){ %>
							<button type="button" class="provider-card text-left flex-1 min-w-[220px]" data-provider="<%= provider.id %>" aria-checked="false" role="radio">
								<div class="flex items-center justify-between">
									<p class="font-semibold"><%= provider.name %></p>
									<% if (provider.badge) { %>
									<span class="text-[0.65rem] uppercase tracking-widest text-cyan-200"><%= provider.badge %></span>
									<% } %>
								</div>
								<p class="text-sm text-slate-300">Host: <%= provider.host %> ¬∑ Port: <%= provider.port %></p>
							</button>
							<% }) %>
						</div> -->
						<label class="flex flex-col gap-2 text-sm">
							<span class="flex items-center justify-between">
								<span>Provider list</span>
								<span class="text-xs text-slate-400" id="providerNote">Select a preset to auto-fill host settings.</span>
							</span>
							<select id="providerSelect" class="rounded-2xl bg-slate-900/60 border border-white/10 px-4 py-3 focus:outline-none focus:border-cyan-300">
								<option value="custom">Custom</option>
								<% (providers || []).forEach(function(provider){ %>
								<option value="<%= provider.id %>"><%= provider.name %></option>
								<% }) %>
							</select>
						</label>
					</fieldset>

					<fieldset class="space-y-5">
						<legend class="text-sm font-semibold tracking-[0.2em] uppercase text-slate-400">Message</legend>
						<label class="flex flex-col gap-2 text-sm">Subject line
							<div class="flex items-center justify-between text-xs text-slate-400" aria-live="polite" id="subjectCounter">0 / 140</div>
							<input type="text" name="subject" required maxlength="140" class="w-full rounded-2xl bg-slate-900/60 border border-white/10 px-4 py-3 focus:outline-none focus:border-cyan-300" placeholder="üëü Weekly ops check-in" />
						</label>
						<label class="flex flex-col gap-2 text-sm">Message body
							<div class="flex items-center justify-between text-xs text-slate-400" aria-live="polite" id="messageCounter">0 words</div>
							<textarea name="message" required rows="8" class="rounded-3xl bg-slate-900/60 border border-white/10 px-4 py-3 focus:outline-none focus:border-cyan-300" placeholder="Hi $(first_name), thanks for shipping with us..."></textarea>
						</label>
						<!-- <div class="grid gap-4 md:grid-cols-2">
							<div class="preview-card" aria-live="polite">
								<p class="text-xs uppercase tracking-[0.35em] text-slate-400">Inbox preview</p>
								<p class="font-semibold mt-2 text-white truncate" id="subjectPreview">Subject shows up here</p>
								<p class="text-sm text-slate-400 preview-body mt-1" id="messagePreview">Body snippet appears here once you start typing. This helps you keep the first 3 lines crisp.</p>
							</div>
							<div class="preview-card">
								<p class="text-xs uppercase tracking-[0.35em] text-slate-400">Personalization tips</p>
								<ul class="mt-2 space-y-1 text-sm text-slate-300 list-disc list-inside">
									<li>Stick to one clear CTA per send.</li>
									<li>Reference columns like <code class="font-mono text-xs">$(company)</code> for instant context.</li>
									<li>Keep first sentence under 80 characters for mobile inboxes.</li>
								</ul>
							</div>
						</div> -->
						<label class="flex flex-col gap-2 text-sm">Send delay per email
							<div class="flex items-center justify-between text-xs text-slate-400"><span>Throttle to protect sender reputation.</span><span id="delayDisplay"><%= defaults.defaultDelayMs %> ms/email</span></div>
							<input type="range" name="delayMs" min="0" max="2500" step="50" value="<%= defaults.defaultDelayMs %>" class="w-full" />
						</label>
					</fieldset>

					<fieldset class="space-y-5">
						<legend class="text-sm font-semibold tracking-[0.2em] uppercase text-slate-400">Contacts CSV</legend>
						<input type="file" name="contacts" id="contacts" accept=".csv" class="sr-only" />
						<div id="csvDropZone" class="dropzone flex flex-col gap-4" tabindex="0" role="button" aria-describedby="csvHint">
							<div class="flex items-center gap-3">
								<div class="h-12 w-12 rounded-2xl bg-white/10 flex items-center justify-center text-white">üì§</div>
								<div>
									<p class="font-semibold">Drop CSV to import or click to browse</p>
									<p class="text-sm text-slate-400" id="csvFileLabel">No file selected yet ‚Äî limit <%= defaults.maxRecipients %> rows ¬∑ <%= defaults.maxFileMb %> MB.</p>
								</div>
							</div>
							<div class="flex flex-wrap gap-3 text-sm">
								<button type="button" id="browseCsvButton" class="px-4 py-2 rounded-2xl border border-white/20 text-slate-200 hover:border-white/40">Browse files</button>
								<button type="button" id="clearCsvButton" class="px-4 py-2 rounded-2xl border border-white/20 text-slate-400" aria-disabled="true" disabled>Clear</button>
								<a href="/sample-data/demo_contacts.csv" class="px-4 py-2 rounded-2xl border border-white/10 text-slate-200 hover:border-white/40" download>Download template</a>
							</div>
						</div>
						<p class="text-xs text-slate-400" id="csvHint">Ensure the first row lists column names. We automatically detect the email column.</p>
					</fieldset>

					<div class="flex flex-col gap-4">
						<div id="formAlerts" class="flex flex-wrap gap-2" aria-live="polite"></div>
						<button type="submit" class="inline-flex items-center justify-center gap-2 bg-cyan-400/90 hover:bg-cyan-300 text-slate-900 font-semibold rounded-2xl px-6 py-3" aria-live="polite">
							<span id="submitLabel">Send campaign</span>
							<span id="spinner" class="w-4 h-4 border-2 border-slate-900 border-t-transparent rounded-full animate-spin hidden"></span>
						</button>
					</div>
				</form>
			</div>

			<aside class="lg:h-screen lg:pb-20 space-y-8 overflow-y-auto">
        				<section class="glass-panel rounded-[32px] p-8 space-y-6" aria-live="polite">
					<div class="flex flex-wrap items-center justify-between gap-3">
						<div>
							<p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">Live delivery telemetry</p>
							<h3 class="text-2xl font-semibold mt-2">Status and pacing</h3>
						</div>
						<span id="statusBadge" class="status-pill status-pill--idle" role="status" aria-live="polite">IDLE</span>
					</div>
					<div class="space-y-3" aria-label="Campaign progress">
						<div class="flex items-center justify-between text-sm text-slate-400">
							<span id="progressLabel">Awaiting campaign</span>
							<span id="progressNumbers">0 / 0</span>
						</div>
						<div class="h-2 rounded-full bg-white/10 overflow-hidden" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
							<div id="progressBar" class="h-full bg-gradient-to-r from-cyan-400 to-emerald-400" style="width: 0%"></div>
						</div>
					</div>
					<div class="grid gap-3 md:grid-cols-3">
						<div class="rounded-2xl border border-white/10 p-4">
							<p class="text-xs uppercase tracking-[0.3em] text-slate-400">Sent</p>
							<p class="text-2xl font-semibold" id="sentCount">0</p>
						</div>
						<div class="rounded-2xl border border-white/10 p-4">
							<p class="text-xs uppercase tracking-[0.3em] text-slate-400">Failed</p>
							<p class="text-2xl font-semibold" id="failedCount">0</p>
						</div>
						<div class="rounded-2xl border border-white/10 p-4">
							<p class="text-xs uppercase tracking-[0.3em] text-slate-400">Total</p>
							<p class="text-2xl font-semibold" id="totalCount">0</p>
						</div>
					</div>
					<div class="space-y-3">
						<div class="flex items-center justify-between">
							<p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">Activity log</p>
							<span class="text-xs text-slate-400">Newest first</span>
						</div>
						<ul id="logList" class="space-y-2 max-h-72 overflow-auto" aria-live="polite">
							<li class="text-slate-500 text-sm">No events yet. Launch a campaign to view updates.</li>
						</ul>
					</div>
				</section>
				<section class="glass-panel rounded-[32px] p-6 space-y-4">
					<div class="flex items-center justify-between">
						<p class="text-xs font-semibold uppercase tracking-[0.35em] text-slate-400">CSV preview</p>
						<span class="text-xs text-slate-400">First 5 rows</span>
					</div>
					<div class="space-y-3 text-sm" id="csvSummary">
						<p class="text-slate-400">Upload a CSV to preview columns &amp; sample rows.</p>
					</div>
					<div class="overflow-x-auto" id="csvTable"></div>
				</section>

				<section class="glass-panel rounded-[32px] p-6 space-y-4">
					<div class="flex items-center justify-between">
						<p class="text-xs font-semibold uppercase tracking-[0.35em] text-slate-400">Placeholder playbook</p>
						<span class="rounded-full bg-emerald-400/15 px-3 py-1 text-[0.65rem] font-semibold text-emerald-200">Pro tip</span>
					</div>
					<ul class="space-y-3 text-sm text-slate-200">
						<li class="border border-white/10 rounded-2xl px-3 py-2">Use <code class="font-mono text-xs">$(column_name)</code> anywhere in subject/body.</li>
						<li class="border border-white/10 rounded-2xl px-3 py-2">Column names are case-sensitive and read from your header row.</li>
						<li class="border border-white/10 rounded-2xl px-3 py-2">Missing data gracefully renders as an empty string.</li>
						<li class="border border-white/10 rounded-2xl px-3 py-2">Keep HTML lightweight; inline styles land better than linked CSS.</li>
					</ul>
				</section>

				<section class="glass-panel rounded-[32px] p-6 space-y-3">
					<p class="text-xs font-semibold uppercase tracking-[0.35em] text-slate-400">Provider docs</p>
					<ul class="space-y-2 text-sm">
						<% (providers || []).forEach(function(provider){ %>
						<li>
							<a href="<%= provider.docUrl %>" target="_blank" rel="noreferrer" class="flex items-center justify-between rounded-2xl border border-white/10 px-4 py-2 text-slate-200 hover:text-white hover:border-white/30 transition">
								<span><%= provider.name %></span>
								<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 5h6m0 0v6m0-6L10 14" />
								</svg>
							</a>
						</li>
						<% }) %>
					</ul>
				</section>
			</aside>
		</section>
	</main>

	<footer class="text-center text-xs text-slate-500 py-8">
		Made with ‚ù§Ô∏è by <a href="https://github.com/rewar1311" target="_blank" rel="noreferrer" class="underline">Prashant Rewar</a>
	</footer>

	<script id="providerData" type="application/json"><%- JSON.stringify(providers || []) %></script>

	<script>
		const providerDataEl = document.getElementById('providerData');
		const PROVIDERS = providerDataEl ? JSON.parse(providerDataEl.textContent || '[]') : [];
		const form = document.getElementById('mailerForm');
		const formAlerts = document.getElementById('formAlerts');
		const contactsInput = document.getElementById('contacts');
		const csvDropZone = document.getElementById('csvDropZone');
		const csvFileLabel = document.getElementById('csvFileLabel');
		const browseCsvButton = document.getElementById('browseCsvButton');
		const clearCsvButton = document.getElementById('clearCsvButton');
		const csvSummary = document.getElementById('csvSummary');
		const csvTable = document.getElementById('csvTable');
		const statusBadge = document.getElementById('statusBadge');
		const progressBar = document.getElementById('progressBar');
		const progressLabel = document.getElementById('progressLabel');
		const progressNumbers = document.getElementById('progressNumbers');
		const sentCount = document.getElementById('sentCount');
		const failedCount = document.getElementById('failedCount');
		const totalCount = document.getElementById('totalCount');
		const logList = document.getElementById('logList');
		const providerNote = document.getElementById('providerNote');
		const providerSelect = document.getElementById('providerSelect');
		const providerCards = Array.from(document.querySelectorAll('.provider-card'));
		const submitLabel = document.getElementById('submitLabel');
		const spinner = document.getElementById('spinner');
		const subjectCounter = document.getElementById('subjectCounter');
		const messageCounter = document.getElementById('messageCounter');
		const sampleCopyButton = document.getElementById('sampleCopyButton');
		const resetFormButton = document.getElementById('resetFormButton');
		const delayInput = form?.elements['delayMs'];
		const delayDisplay = document.getElementById('delayDisplay');
		const smtpHostInput = form?.elements['smtpHost'];
		const smtpPortInput = form?.elements['smtpPort'];
		const senderEmailInput = form?.elements['senderEmail'];
		const appPasswordInput = form?.elements['appPassword'];
		const subjectInput = form?.elements['subject'];
		const messageInput = form?.elements['message'];
		const csvBadge = document.getElementById('csvBadge');
		const copyBadge = document.getElementById('copyBadge');
		const throttleBadge = document.getElementById('throttleBadge');
		const subjectPreview = document.getElementById('subjectPreview');
		const messagePreview = document.getElementById('messagePreview');
		const readinessIds = ['readyCsv', 'readyIdentity', 'readyContent', 'readyThrottle'];
		const readinessElements = readinessIds.reduce((acc, id) => {
			acc[id] = document.getElementById(id);
			return acc;
		}, {});
		const quickCards = {
			csv: csvBadge?.closest('.quick-card') || null,
			copy: copyBadge?.closest('.quick-card') || null,
			throttle: throttleBadge?.closest('.quick-card') || null,
		};
		const maxRecipients = Number(form?.dataset?.maxRecipients || 0);
		const maxFileMb = Number(form?.dataset?.maxFileMb || 0);
		const maxBytes = maxFileMb ? maxFileMb * 1024 * 1024 : null;
		const csvDropDefault = `No file selected yet ‚Äî limit ${maxRecipients} rows ¬∑ ${maxFileMb} MB cap.`;
		let eventSource = null;

		const STATUS_STYLES = {
			queued: 'status-pill status-pill--queued',
			running: 'status-pill status-pill--running',
			completed: 'status-pill status-pill--completed',
			failed: 'status-pill status-pill--failed',
			idle: 'status-pill status-pill--idle',
		};
		const SAFE_DELAY_MS = 400;

		const preventDefaults = (event) => {
			event.preventDefault();
			event.stopPropagation();
		};

		const setCsvFileLabel = (message = csvDropDefault) => {
			if (csvFileLabel) {
				csvFileLabel.textContent = message;
			}
		};

		const resetCsvPreview = () => {
			if (csvSummary) {
				csvSummary.innerHTML = '<p class="text-slate-400">Upload a CSV to preview columns & sample rows.</p>';
			}
			if (csvTable) {
				csvTable.innerHTML = '';
			}
		};

		const formatBytes = (bytes) => {
			if (!Number.isFinite(bytes)) return '';
			if (bytes >= 1048576) return `${(bytes / 1048576).toFixed(1)} MB`;
			if (bytes >= 1024) return `${(bytes / 1024).toFixed(1)} KB`;
			return `${bytes} B`;
		};

		const setQuickCardState = (card, state = 'idle') => {
			if (!card) return;
			card.setAttribute('data-state', state);
		};

		const updateCsvBadgeDisplay = (info = null) => {
			if (!csvBadge) return;
			if (!info) {
				csvBadge.textContent = 'No CSV attached';
				setQuickCardState(quickCards.csv, 'idle');
				return;
			}
			const parts = [info.name];
			if (info.columns) {
				parts.push(`${info.columns} cols`);
			}
			if (info.size) {
				parts.push(info.size);
			}
			csvBadge.textContent = parts.join(' ¬∑ ');
			setQuickCardState(quickCards.csv, 'ready');
		};

		const updateCopyBadge = () => {
			if (!copyBadge) return;
			const ready = Boolean(subjectInput?.value.trim() && messageInput?.value.trim());
			copyBadge.textContent = ready ? 'Story dialed in' : 'Draft in progress';
			setQuickCardState(quickCards.copy, ready ? 'ready' : 'idle');
		};

		const updatePreviews = () => {
			if (subjectPreview && subjectInput) {
				const subjectText = subjectInput.value.trim();
				subjectPreview.textContent = subjectText || 'Subject shows up here';
			}
			if (messagePreview && messageInput) {
				const body = messageInput.value.trim();
				messagePreview.textContent = body || 'Body snippet appears here once you start typing. This helps you keep the first 3 lines crisp.';
			}
		};

		const readinessChecks = [
			{ id: 'readyCsv', test: () => Boolean(contactsInput?.files?.length) },
			{ id: 'readyIdentity', test: () => Boolean(senderEmailInput?.value.trim() && appPasswordInput?.value.trim()) },
			{ id: 'readyContent', test: () => Boolean(subjectInput?.value.trim() && messageInput?.value.trim()) },
			{ id: 'readyThrottle', test: () => Number(delayInput?.value || 0) >= SAFE_DELAY_MS },
		];

		const refreshReadiness = () => {
			readinessChecks.forEach((item) => {
				const element = readinessElements[item.id];
				if (!element) return;
				const isReady = Boolean(item.test());
				element.dataset.state = isReady ? 'done' : 'pending';
				const chip = element.querySelector('.readiness-chip');
				if (chip) {
					chip.textContent = isReady ? 'Ready' : 'Waiting';
				}
			});
		};

		const showAlert = (kind = 'info', message = '') => {
			if (!message || !formAlerts) return;
			const alert = document.createElement('span');
			const palette = {
				success: 'form-alert form-alert-success',
				error: 'form-alert form-alert-error',
				warning: 'form-alert form-alert-warning',
				info: 'form-alert form-alert-info',
			};
			alert.className = palette[kind] || palette.info;
			alert.textContent = message;
			alert.setAttribute('role', 'status');
			alert.setAttribute('aria-live', 'polite');
			formAlerts.appendChild(alert);
			setTimeout(() => alert.remove(), 7000);
		};

		const toggleLoading = (isLoading) => {
			if (submitLabel) {
				submitLabel.textContent = isLoading ? 'Scheduling campaign‚Ä¶' : 'Send campaign';
			}
			if (spinner) {
				spinner.classList.toggle('hidden', !isLoading);
			}
			if (!form) return;
			form.querySelectorAll('input, textarea, select, button').forEach((el) => {
				if (el.type === 'file') return;
				el.disabled = isLoading;
			});
		};

		const renderCsvPreview = (headers = [], rows = []) => {
			if (!headers.length) {
				resetCsvPreview();
				return;
			}
			if (csvSummary) {
				csvSummary.innerHTML = `
					<p class="text-slate-200">${headers.length} columns detected</p>
					<div class="flex flex-wrap gap-2 mt-2 text-xs">
						${headers.map((header) => `<span class="px-3 py-1 rounded-full bg-white/10 text-white border border-white/20">${header}</span>`).join('')}
					</div>`;
			}
			if (!rows.length) {
				if (csvTable) csvTable.innerHTML = '';
				return;
			}
			const table = document.createElement('table');
			table.className = 'min-w-full text-xs text-left border border-white/15 rounded-2xl overflow-hidden dark-table text-slate-200';
			table.innerHTML = `
				<thead class="text-slate-200">
					<tr>
						${headers.map((header) => `<th class="px-3 py-2 font-medium">${header}</th>`).join('')}
					</tr>
				</thead>
				<tbody>
					${rows.map((row) => `
						<tr class="text-slate-100">
							${headers.map((header) => `<td class="px-3 py-2 text-slate-200">${row[header] ?? ''}</td>`).join('')}
						</tr>
					`).join('')}
				</tbody>`;
			if (csvTable) {
				csvTable.innerHTML = '';
				csvTable.appendChild(table);
			}
		};

		const highlightCards = (selectedId) => {
			providerCards.forEach((card, index) => {
				const isActive = card.dataset.provider === selectedId;
				card.classList.toggle('is-active', isActive);
				card.setAttribute('aria-checked', isActive ? 'true' : 'false');
				card.tabIndex = isActive ? 0 : -1;
				if (!selectedId && index === 0) card.tabIndex = 0;
			});
		};

		const applyProvider = (providerId) => {
			const provider = PROVIDERS.find((item) => item.id === providerId);
			if (provider) {
				if (smtpHostInput) smtpHostInput.value = provider.host || '';
				if (smtpPortInput) smtpPortInput.value = provider.port || '';
				if (providerNote) providerNote.textContent = provider.note || 'Preset applied. Review throttle before send.';
				if (providerSelect) providerSelect.value = provider.id;
			} else {
				if (providerSelect) providerSelect.value = 'custom';
				if (providerNote) providerNote.textContent = 'Custom mode ‚Äî drop in SMTP host + port manually above.';
			}
			highlightCards(provider ? provider.id : null);
		};

		const syncDelayDisplay = () => {
			if (!delayInput || !delayDisplay) return;
			const value = Number(delayInput.value || 0);
			delayDisplay.textContent = `${value} ms/email`;
			if (throttleBadge) {
				throttleBadge.textContent = `${value} ms/email`;
			}
			setQuickCardState(quickCards.throttle, value >= SAFE_DELAY_MS ? 'ready' : 'idle');
			refreshReadiness();
		};

		const updateSubjectCounter = () => {
			if (!subjectInput || !subjectCounter) return;
			const max = Number(subjectInput.getAttribute('maxlength')) || 0;
			subjectCounter.textContent = max ? `${subjectInput.value.length} / ${max}` : `${subjectInput.value.length}`;
		};

		const updateMessageCounter = () => {
			if (!messageInput || !messageCounter) return;
			const words = messageInput.value.trim() ? messageInput.value.trim().split(/\s+/).filter(Boolean).length : 0;
			messageCounter.textContent = `${words} word${words === 1 ? '' : 's'}`;
		};

		const handleCsvClear = (silent = false) => {
			if (contactsInput) contactsInput.value = '';
			setCsvFileLabel(csvDropDefault);
			if (clearCsvButton) {
				clearCsvButton.disabled = true;
				clearCsvButton.setAttribute('aria-disabled', 'true');
			}
			if (!silent) resetCsvPreview();
			updateCsvBadgeDisplay();
			refreshReadiness();
		};

		const handleCsvSelection = (file) => {
			if (!file) {
				handleCsvClear();
				return;
			}
			const isCsv = file.type === 'text/csv' || file.name.toLowerCase().endsWith('.csv');
			if (!isCsv) {
				showAlert('warning', 'Please upload a CSV file.');
				handleCsvClear();
				return;
			}
			if (maxBytes && file.size > maxBytes) {
				showAlert('error', `File exceeds the ${maxFileMb} MB limit. Choose a smaller CSV.`);
				handleCsvClear();
				return;
			}
			setCsvFileLabel(`${file.name} ¬∑ ${formatBytes(file.size)}`);
			if (clearCsvButton) {
				clearCsvButton.disabled = false;
				clearCsvButton.setAttribute('aria-disabled', 'false');
			}
			Papa.parse(file, {
				header: true,
				skipEmptyLines: true,
				preview: 5,
				complete: (results) => {
					if (results.errors?.length) {
						showAlert('error', `CSV error: ${results.errors[0].message}`);
						handleCsvClear();
						return;
					}
					const sanitizedRows = results.data.filter((row) => Object.keys(row).length);
					const headers = Object.keys(sanitizedRows[0] || {});
					if (!headers.length) {
						showAlert('warning', 'No headers detected. Ensure the first row lists column names.');
						resetCsvPreview();
						return;
					}
					renderCsvPreview(headers, sanitizedRows);
					updateCsvBadgeDisplay({ name: file.name, columns: headers.length, size: formatBytes(file.size) });
					refreshReadiness();
				},
			});
		};

		const assignFileToInput = (file) => {
			if (!file || !contactsInput) return;
			if (typeof DataTransfer === 'undefined') {
				showAlert('info', 'Drag & drop not supported here. Use the browse button instead.');
				return;
			}
			const dataTransfer = new DataTransfer();
			dataTransfer.items.add(file);
			contactsInput.files = dataTransfer.files;
			contactsInput.dispatchEvent(new Event('change', { bubbles: true }));
		};

		providerCards.forEach((card) => {
			card.addEventListener('click', () => applyProvider(card.dataset.provider));
			card.addEventListener('keydown', (event) => {
				if (event.key === 'Enter' || event.key === ' ') {
					event.preventDefault();
					applyProvider(card.dataset.provider);
				}
			});
		});

		if (document.getElementById('providerCards')) {
			document.getElementById('providerCards').addEventListener('keydown', (event) => {
				if (!['ArrowRight', 'ArrowDown', 'ArrowLeft', 'ArrowUp'].includes(event.key)) return;
				event.preventDefault();
				const activeIndex = providerCards.findIndex((card) => card.classList.contains('is-active'));
				const fallbackIndex = activeIndex >= 0 ? activeIndex : 0;
				const delta = ['ArrowRight', 'ArrowDown'].includes(event.key) ? 1 : -1;
				let nextIndex = fallbackIndex + delta;
				if (nextIndex < 0) nextIndex = providerCards.length - 1;
				if (nextIndex >= providerCards.length) nextIndex = 0;
				const nextCard = providerCards[nextIndex];
				nextCard.focus();
				applyProvider(nextCard.dataset.provider);
			});
		}

		if (providerSelect) {
			providerSelect.addEventListener('change', (event) => {
				const value = event.target.value;
				applyProvider(value === 'custom' ? null : value);
			});
		}

		if (contactsInput) {
			contactsInput.addEventListener('change', () => {
				handleCsvSelection(contactsInput.files?.[0]);
			});
		}

		if (browseCsvButton && contactsInput) {
			browseCsvButton.addEventListener('click', () => contactsInput.click());
		}

		if (clearCsvButton) {
			clearCsvButton.addEventListener('click', () => {
				handleCsvClear();
				showAlert('info', 'CSV selection cleared.');
			});
		}

		if (csvDropZone) {
			['dragenter', 'dragover'].forEach((eventName) => {
				csvDropZone.addEventListener(eventName, (event) => {
					preventDefaults(event);
					csvDropZone.classList.add('dropzone--active');
				});
			});
			['dragleave', 'drop'].forEach((eventName) => {
				csvDropZone.addEventListener(eventName, (event) => {
					preventDefaults(event);
					csvDropZone.classList.remove('dropzone--active');
				});
			});
			csvDropZone.addEventListener('click', () => contactsInput?.click());
			csvDropZone.addEventListener('keydown', (event) => {
				if (event.key === 'Enter' || event.key === ' ') {
					event.preventDefault();
					contactsInput?.click();
				}
			});
			csvDropZone.addEventListener('drop', (event) => {
				const file = event.dataTransfer?.files?.[0];
				if (file) assignFileToInput(file);
			});
		}

		if (sampleCopyButton && subjectInput && messageInput) {
			sampleCopyButton.addEventListener('click', () => {
				subjectInput.value = 'üëü Pulse Courier ‚Äî Weekly ops check-in';
				messageInput.value = `Hi $(first_name),\n\nThanks for keeping $(company) ahead of inbox limits. We just rolled out adaptive throttling that honors your preferred send window.\n\n‚Ä¢ Latest release: domain smart pacing\n‚Ä¢ Next steps: confirm your ideal throttle\n\nPing me if you want us to white-glove the migration.\n\n‚Äî $(sender_name || 'Pulse Courier')`;
				updateSubjectCounter();
				updateMessageCounter();
				showAlert('info', 'Sample subject + body loaded. Tweak before sending.');
			});
		}

		if (resetFormButton && form) {
			resetFormButton.addEventListener('click', () => {
				form.reset();
				applyProvider(null);
				handleCsvClear();
				resetCsvPreview();
				updateSubjectCounter();
				updateMessageCounter();
				syncDelayDisplay();
				showAlert('info', 'Form reset. Start fresh.');
			});
		}

		if (subjectInput) {
			subjectInput.addEventListener('input', () => {
				updateSubjectCounter();
				updateCopyBadge();
				updatePreviews();
				refreshReadiness();
			});
			updateSubjectCounter();
		}

		if (messageInput) {
			messageInput.addEventListener('input', () => {
				updateMessageCounter();
				updateCopyBadge();
				updatePreviews();
				refreshReadiness();
			});
			updateMessageCounter();
		}

		if (delayInput) {
			delayInput.addEventListener('input', syncDelayDisplay);
			syncDelayDisplay();
		}

		const formatTime = (timestamp) => {
			if (!timestamp) return '';
			try {
				return new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit' }).format(new Date(timestamp));
			} catch (error) {
				return '';
			}
		};

		const renderLogs = (logs = []) => {
			if (!logList) return;
			if (!logs.length) {
				logList.innerHTML = '<li class="text-slate-500">No events yet. Launch a campaign to see updates.</li>';
				return;
			}
			logList.innerHTML = '';
			logs.slice(0, 25).forEach((entry) => {
				const item = document.createElement('li');
				const tone = entry.kind === 'error' ? 'text-rose-300' : 'text-emerald-300';
				const icon = entry.kind === 'error' ? '‚õî' : '‚úÖ';
				item.className = 'rounded-2xl border border-white/10 px-3 py-2 flex items-center justify-between text-xs text-slate-200 bg-white/5';
				item.innerHTML = `
					<span class="flex items-center gap-2 ${tone}">
						<span>${icon}</span>
						${entry.email ? entry.email : entry.message || ''}
					</span>
					<span class="text-slate-500">${formatTime(entry.at)}</span>`;
				logList.appendChild(item);
			});
		};

		const hydrateState = (state) => {
			if (!state) return;
			const total = Number(state.total) || 0;
			const sent = Number(state.sent) || 0;
			const failed = Number(state.failed) || 0;
			const processed = sent + failed;
			const percent = total ? Math.min(100, Math.round((processed / total) * 100)) : 0;

			if (sentCount) sentCount.textContent = sent;
			if (failedCount) failedCount.textContent = failed;
			if (totalCount) totalCount.textContent = total;
			if (progressNumbers) progressNumbers.textContent = `${processed} / ${total}`;
			if (progressBar) {
				progressBar.style.width = `${percent}%`;
				progressBar.setAttribute('aria-valuenow', percent);
			}
			if (progressLabel) {
				progressLabel.textContent = state.status === 'running'
					? 'Sending emails'
					: state.status === 'completed'
						? 'Campaign completed'
						: state.status === 'failed'
							? 'Campaign failed'
							: 'Queued';
			}

			const statusClass = STATUS_STYLES[state.status] || STATUS_STYLES.idle;
			if (statusBadge) {
				statusBadge.className = statusClass;
				statusBadge.textContent = (state.status || 'idle').toUpperCase();
			}

			if (Array.isArray(state.logs)) {
				renderLogs(state.logs);
			}

			if (Array.isArray(state.sampleColumns) && state.sampleColumns.length && !csvTable?.children.length) {
				renderCsvPreview(state.sampleColumns, []);
			}
		};

		const watchJob = (jobId) => {
			if (!jobId) return;
			if (eventSource) {
				eventSource.close();
			}
			eventSource = new EventSource(`/api/jobs/${jobId}/stream`);
			eventSource.onmessage = (event) => {
				try {
					const payload = JSON.parse(event.data);
					if (payload?.type === 'state') {
						hydrateState(payload.data);
					}
				} catch (error) {
					console.warn('SSE parse error', error);
				}
			};
			eventSource.onerror = () => {
				eventSource?.close();
				eventSource = null;
			};
		};

		if (form) {
			form.addEventListener('submit', async (event) => {
				event.preventDefault();
				if (formAlerts) formAlerts.innerHTML = '';
				if (!contactsInput?.files?.length) {
					showAlert('warning', 'Please attach a CSV file before sending.');
					return;
				}
				const formPayload = new FormData(form);
				toggleLoading(true);
				try {
					const response = await fetch('/api/send', {
						method: 'POST',
						body: formPayload,
					});
					const payload = await response.json().catch(() => ({}));
					if (!response.ok) {
						throw new Error(payload?.message || 'Unable to schedule campaign.');
					}
					showAlert('success', 'Campaign queued. Live status updating below.');
					hydrateState(payload.state);
					watchJob(payload.jobId);
				} catch (error) {
					console.error(error);
					showAlert('error', error.message || 'Unexpected error.');
				} finally {
					toggleLoading(false);
				}
			});
		}

		handleCsvClear(true);
		resetCsvPreview();
		applyProvider(null);
	</script>
</body>

</html>
